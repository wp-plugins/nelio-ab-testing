(function(a){a("#controllers .previous").click(function(){if(a(this).hasClass("disabled")){return}var b=a("#exp-tabs .nav-tab-active").prev();if(b.length>0){NelioABEditExperiment.useTab(b.first().attr("id"))}});a("#controllers .next").click(function(){if(a(this).hasClass("disabled")){return}var b=a("#exp-tabs .nav-tab-active").next();if(b.length>0){NelioABEditExperiment.useTab(b.first().attr("id"))}});a("#controllers .save").click(function(){var b=NelioABEditExperiment.validateCurrentTab();NelioABEditExperiment.manageProgress(b[0],b[1]);if(a(this).hasClass("disabled")){return}NelioABEditExperiment.save()})})(jQuery);var NelioABEditExperiment={validateCurrentTab:false,init:function(){jQuery("#exp_id").attr("value",nelioabBasicInfo.id);jQuery("#exp_name").attr("value",nelioabBasicInfo.name);jQuery("#exp_descr").attr("value",nelioabBasicInfo.description);jQuery("input#exp_name").on("keyup focusout",function(){if(NelioABEditExperiment.validateName()){NelioABEditExperiment.manageProgress(true,true)}else{NelioABEditExperiment.manageProgress(false,false)}});jQuery(document).on("tab-changed",function(b,a){if(a=="tab-info"){NelioABEditExperiment.validateCurrentTab=NelioABEditExperiment.validate}})},useTab:function(h){var g=jQuery;var e=g("#exp-tabs .nav-tab-active");var d=g("#"+h);if(NelioABEditExperiment.validateCurrentTab!==false){var a=NelioABEditExperiment.validateCurrentTab();NelioABEditExperiment.manageProgress(a[0],a[1]);if(d[0]==e.prev()[0]&&!a[0]){return}if(d[0]==e.next()[0]&&!a[1]){return}if(d.hasClass("disabled")){return}}var f=[];var b=[];if(d.prev().length==0){f.push(g("#controllers .previous"))}else{b.push(g("#controllers .previous"))}if(d.next().length==0){f.push(g("#controllers .next"));b.push(g("#controllers .save"))}else{f.push(g("#controllers .save"));b.push(g("#controllers .next"))}if(e.attr("id")==h){var a=h.replace("tab","content");jQuery("#set-of-content-blocks > div").each(function(){if(jQuery(this).attr("id")!=a){jQuery(this).hide()}});jQuery("#"+a).show();for(var c=0;c<f.length;++c){f[c].hide()}for(var c=0;c<b.length;++c){b[c].show()}}else{e.removeClass("nav-tab-active");d.addClass("nav-tab-active");g("#"+e.attr("id").replace("tab","content")).fadeOut(200);g("#controllers").fadeOut(200);g("#"+d.attr("id").replace("tab","content")).delay(200).fadeIn(200);g("#controllers").fadeIn(200);for(var c=0;c<f.length;++c){f[c].delay(200).fadeOut(10)}for(var c=0;c<b.length;++c){b[c].delay(200).fadeIn(10)}}NelioABEditExperiment.manageProgress(true,true);g(document).trigger("tab-changed",[h])},manageProgress:function(b,a){if(b){jQuery("#controllers .previous").removeClass("disabled")}else{jQuery("#controllers .previous").addClass("disabled")}if(a){jQuery("#controllers .next").removeClass("disabled");jQuery("#controllers .save").removeClass("disabled")}else{jQuery("#controllers .next").addClass("disabled");jQuery("#controllers .save").addClass("disabled")}},previewOriginal:function(){var a=jQuery("#exp_original").attr("value");if(a!=-1){window.open(NelioABHomeUrl+"/?p="+a,"_blank")}},save:function(a){if(a===undefined){a="save"}jQuery(document).trigger("save-experiment");smoothTransitions();jQuery(".nelio-exp-form > #action").attr("value",a);jQuery.post(location.href,jQuery(".nelio-exp-form").serialize()).success(function(b){b=jQuery.trim(b);if(b.indexOf("[SUCCESS]")==0){location.href=b.replace("[SUCCESS]","")}else{document.open();document.write(b);document.close()}})},validate:function(){var a=true;if(!NelioABEditExperiment.validateName()){a=false}return[a,a]},validateName:function(){var d=jQuery("#exp_name");var b=d.attr("value").trim();var a=true;if(b.length==0){a=false}for(var c=0;c<nelioabBasicInfo.otherNames.length;++c){otherName=nelioabBasicInfo.otherNames[c].trim();if(otherName==b){a=false}}if(a){d.closest("tr").removeClass("error")}else{d.closest("tr").addClass("error")}return a},};var NelioABGoalCards={lastId:0,goals:[],init:function(){if(jQuery("#tab-goals").length==0){return}var k=JSON.parse(decodeURIComponent(jQuery("#nelioab_goals").attr("value")));NelioABGoalCards.goals=k;for(var d=0;d<k.length;++d){var f=k[d];if(f.id<NelioABGoalCards.id){NelioABGoalCards.id=f.id}}jQuery("#exp_original").change(function(){NelioABGoalCards.getList(".neliocard").each(function(){NelioABGoalCards.recomputeVisibleActions(jQuery(this))})});var e;if(k.length>0){var j=k[0];e=NelioABGoalCards.createCard(k[0].id);e.find(".name .value").text(k[0].name);for(var c=0;c<j.actions.length;++c){var h=j.actions[c];NelioABGoalCards.addAction(h,e)}}else{NelioABGoalCards.create();e=NelioABGoalCards.getList().find(".nelio-card").first();NelioABGoalCards.rename(e.data("goal-id"),jQuery("defaultNameForMainGoal").text())}e.find("h3 .isMain").show();e.find(".name .row-actions .delete").remove();e.find(".name .row-actions .sep").remove();e.find(".form").hide();e.find(".name").show();for(var d=1;d<k.length;++d){var f=k[d];var b=NelioABGoalCards.createCard(f.id);for(var c=0;c<f.actions.length;++c){var h=f.actions[c];NelioABGoalCards.addAction(h,b)}b.find(".name .value").first().text(f.name);b.find(".form").hide();b.find(".name").show();b.show()}jQuery(document).on("tab-changed",function(g,a){if(a=="tab-goals"){NelioABEditExperiment.validateCurrentTab=NelioABGoalCards.validate}});jQuery(document).on("save-experiment",function(){NelioABGoalCards.save()});NelioABGoalCards.getList(".neliocard").each(function(){NelioABGoalCards.recomputeVisibleActions(jQuery(this))})},getList:function(){return jQuery("#goal-list")},getGoalById:function(c){var b=NelioABGoalCards.goals;for(var a=0;a<b.length;++a){if(b[a].id==c){return b[a]}}return false},create:function(){var c=NelioABGoalCards.getList();var d=jQuery("#goal-template span.name > .value").text();--NelioABGoalCards.lastId;var b={id:NelioABGoalCards.lastId,isNew:true,name:d+" ("+(-NelioABGoalCards.lastId)+")",wasDeleted:false,};NelioABGoalCards.goals.push(b);var a=NelioABGoalCards.createCard(NelioABGoalCards.lastId);a.find("span.name .value").text(b.name);a.find("span.form").hide();a.find("span.name").show();a.show()},rename:function(c,b){var a=NelioABGoalCards.getGoalById(c);if(a){a.name=b}},createCard:function(c){var a=jQuery("#goal-template").clone();a.data("goal-id",c);a.removeAttr("id");a.find("h3 .form input.new-name").on("keyup focusout",function(){NelioABGoalCards.validateGoalName(a)});a.find("h3 .form .rename").click(function(){if(!NelioABGoalCards.validateGoalName(a)){return}var d=a.find(".new-name").first().attr("value");NelioABGoalCards.rename(c,d);a.find("span.name > .value").text(d);a.find("span.form").hide();a.find("span.name").show()});a.find("h3 .name .rename a").click(function(){var d=a.find("span.name > .value").text();a.find(".new-name").first().attr("value",d);a.find("span.form").show();a.find("span.name").hide()});a.find("h3 .name .delete a").click(function(){NelioABGoalCards.remove(a)});a.find(".new-actions .page").click(function(){if(jQuery(this).hasClass("disabled")){return}NelioABGoalCards.addAction({isNew:true,type:"page"},a)});a.find(".new-actions .post").click(function(){if(jQuery(this).hasClass("disabled")){return}NelioABGoalCards.addAction({isNew:true,type:"post"},a)});a.find(".new-actions .external-page").click(function(){if(jQuery(this).hasClass("disabled")){return}NelioABGoalCards.addAction({isNew:true,type:"external-page"},a)});var b=NelioABGoalCards.getList();b.append(a);return a},remove:function(b){var a=NelioABGoalCards.getGoalById(b.data("goal-id"));a.wasDeleted=true;b.remove()},addAction:function(c,b){var a;switch(c.type){case"post":case"page":a=b.find(".new-"+c.type+"-action").clone();a.removeClass("new-"+c.type+"-action");a.find("select."+c.type).first().change(function(){NelioABGoalCards.recomputeVisibleActions(b)});if(c.isNew!==true){if(c.isIndirect){a.find(".direct").attr("value","0")}else{a.find(".direct").attr("value","1")}a.find("."+c.type).attr("value",c.value)}b.find(".actions").append(a);b.find(".empty").hide();b.find(".actions").show();a.show();NelioABGoalCards.recomputeVisibleActions(b);break;case"external-page":a=b.find(".new-external-page-action").clone();a.removeClass("new-external-page-action");if(c.isNew!==true){a.find(".name").attr("value",c.name);a.find(".url").attr("value",c.url)}a.find(".name").on("keyup focusout",function(){NelioABGoalCards.validateExternalPage(a,"name")});a.find(".url").on("keyup focusout",function(){NelioABGoalCards.validateExternalPage(a,"url")});b.find(".actions").append(a);b.find(".empty").hide();b.find(".actions").show();a.show();break;default:return false}a.data("type",c.type);a.find("a.delete").click(function(){a.remove();if(b.find(".actions .action").length==0){b.find(".actions").hide();b.find(".empty").show()}NelioABEditExperiment.manageProgress(true,true);NelioABGoalCards.recomputeVisibleActions(b)});return a},recomputeVisibleActions:function(a){var d=["post","page"];var f=jQuery("#exp_original").attr("value");a.find(".actions .action select").each(function(){if(jQuery(this).attr("value")==f){if(jQuery(this).hasClass("post")||jQuery(this).hasClass("page")){jQuery(this).closest(".action").remove()}}});if(a.find(".actions .action").length==0){a.find(".actions").hide();a.find(".empty").show()}for(var h=0;h<d.length;++h){var e=d[h];var g=[f];a.find(".new-action-templates select."+e+" option").show();a.find(".actions .action select."+e).each(function(){jQuery(this).find("option").show();g.push(jQuery(this).attr("value"))});for(var c=0;c<g.length;++c){a.find(".action select."+e+" option[value="+g[c]+"]").hide()}a.find(".actions .action select."+e).each(function(){jQuery(this).find("option[value="+jQuery(this).attr("value")+"]").show()});var b=0;var j=a.find(".new-action-templates select."+e);j.find("option").each(function(){jQuery(this).removeAttr("selected");if(jQuery(this).css("display")!="none"&&b==0){jQuery(this).attr("selected","selected");b=jQuery(this).attr("value")}});j.attr("value",b);if(b==0){jQuery(".new-actions a."+e).addClass("disabled")}else{jQuery(".new-actions a."+e).removeClass("disabled")}}},validate:function(){var a=true;var b=true;jQuery("#goal-list .nelio-card").each(function(){if(jQuery(this).find(".form").css("display")!="none"){a=b=false;jQuery(this).find(".new-name").first().addClass("error")}});jQuery("#goal-list .actions .external-page input").each(function(){var c=jQuery(this).closest(".action");if(jQuery(this).hasClass("name")){b=NelioABGoalCards.validateExternalPage(c,"name")&&b}if(jQuery(this).hasClass("url")){b=NelioABGoalCards.validateExternalPage(c,"url")&&b}});return[a,b]},validateGoalName:function(d){var b=d.find(".new-name").first();var c=b.attr("value").trim();var a=true;if(c.length==0){a=false}for(var e=0;e<NelioABGoalCards.goals.length;++e){var f=NelioABGoalCards.goals[e];if(f.wasDeleted){continue}if(f.id==d.data("goal-id")){continue}otherName=f.name;if(otherName==c){a=false}}if(a){b.removeClass("error");d.find(".form .button.rename").removeClass("disabled");NelioABEditExperiment.manageProgress(true,true)}else{b.addClass("error");d.find(".form .button.rename").addClass("disabled");NelioABEditExperiment.manageProgress(false,false)}return a},validateExternalPage:function(g,f,d){if(d==undefined){d=false}var c=g.closest(".nelio-card");var b=g.find("input."+f);var e=b.attr("value").trim();var a=true;if(e.length==0){a=false}if(a){c.find(".actions .action.external-page").each(function(){if(g[0]!=jQuery(this)[0]){var h=jQuery(this).find("input."+f);var i=h.attr("value").trim();if(i==e){h.addClass("error");a=false}}});if(!d){c.find(".actions .action.external-page input.error."+f).each(function(){NelioABGoalCards.validateExternalPage(jQuery(this).closest(".action"),f,true)})}}if(a){b.removeClass("error");NelioABEditExperiment.manageProgress(true,true)}else{b.addClass("error");NelioABEditExperiment.manageProgress(false,false)}return a},save:function(){var c=NelioABGoalCards.getList().find(".nelio-card");for(var a=0;a<NelioABGoalCards.goals.length;++a){var b=NelioABGoalCards.goals[a];b.actions=[]}c.each(function(){var d=jQuery(this);var e=NelioABGoalCards.getGoalById(d.data("goal-id"));e.name=d.find(".name .value").text();var f=d.find(".actions .action").each(function(){var h=jQuery(this);var g={};g.type=h.data("type");switch(h.data("type")){case"page":case"post":g.value=h.find("."+h.data("type")).attr("value");g.isIndirect=h.find(".direct").attr("value")=="0";e.actions.push(g);break;case"external-page":g.name=h.find(".name").attr("value");g.url=h.find(".url").attr("value");e.actions.push(g);break}})});jQuery("#nelioab_goals").attr("value",encodeURIComponent(JSON.stringify(NelioABGoalCards.goals)).replace("'","%27"))},};(function(d){NelioABEditExperiment.init();NelioABGoalCards.init();var c=window.location.search.replace("?","").split("&");var f=jQuery("#exp-tabs .nav-tab-active").attr("id");for(var b=0;b<c.length;++b){var e=c[b].indexOf("ctab");if(e===0){var a=c[b].substring(c[b].indexOf("=")+1);if(a!="tab-goals"&&jQuery("#"+a).length>0){f=a}break}}jQuery("#exp-tabs .nav-tab-active").removeClass("nav-tab-active");jQuery("#"+f).addClass("nav-tab-active")})(jQuery);